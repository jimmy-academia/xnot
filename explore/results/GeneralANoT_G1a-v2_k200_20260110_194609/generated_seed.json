{
  "task_name": "G1a-v2",
  "filter_keywords": [
    "allergy",
    "allergic",
    "peanut",
    "nut",
    "peanuts",
    "epipen",
    "anaphylaxis",
    "hives",
    "swelling",
    "rash",
    "allergies",
    "allergy safety"
  ],
  "extraction_fields": [
    {
      "name": "incident_severity",
      "field_type": "enum",
      "values": [
        "none",
        "mild",
        "moderate",
        "severe"
      ],
      "description": "Severity of allergic reaction described in the review",
      "extraction_hint": "none=No reaction described; mild=stomach upset; mild discomfort; moderate=hives, swelling, needed medication; severe=life-threatening (anaphylaxis, EpiPen, ER)"
    },
    {
      "name": "account_type",
      "field_type": "enum",
      "values": [
        "none",
        "firsthand",
        "secondhand",
        "hypothetical"
      ],
      "description": "Source of the allergy account",
      "extraction_hint": "firsthand=I had, my child experienced; secondhand=I heard, friend told me; hypothetical=concern without incident; none=no account described"
    },
    {
      "name": "safety_interaction",
      "field_type": "enum",
      "values": [
        "none",
        "positive",
        "negative",
        "betrayal"
      ],
      "description": "Staff interaction regarding allergy safety and accommodation",
      "extraction_hint": "positive=Staff asked about allergies AND accommodated; negative=Staff dismissive or refused to accommodate; betrayal=Staff claimed safe BUT customer still had reaction; none=No interaction described"
    }
  ],
  "extraction_prompt": "Analyze this restaurant review and extract the following signals.\n\nREVIEW:\n{review_text}\n\nREVIEW METADATA:\n- Date: {review_date}\n- Stars: {review_stars}\n- Useful votes: {review_useful}\n\nEXTRACT THESE FIELDS:\n\n**incident_severity**\n  Type: Choose ONE of ['none', 'mild', 'moderate', 'severe']\n  Description: Severity of allergic reaction described in the review\n  Hints: none=No reaction described; mild=stomach upset; mild discomfort; moderate=hives, swelling, needed medication; severe=life-threatening (anaphylaxis, EpiPen, ER)\n\n**account_type**\n  Type: Choose ONE of ['none', 'firsthand', 'secondhand', 'hypothetical']\n  Description: Source of the allergy account\n  Hints: firsthand=I had, my child experienced; secondhand=I heard, friend told me; hypothetical=concern without incident; none=no account described\n\n**safety_interaction**\n  Type: Choose ONE of ['none', 'positive', 'negative', 'betrayal']\n  Description: Staff interaction regarding allergy safety and accommodation\n  Hints: positive=Staff asked about allergies AND accommodated; negative=Staff dismissive or refused to accommodate; betrayal=Staff claimed safe BUT customer still had reaction; none=No interaction described\n\nOUTPUT FORMAT:\nReturn a JSON object with these exact keys:\n{\n  \"incident_severity\": \"<one of ['none', 'mild', 'moderate', 'severe']>\",\n  \"account_type\": \"<one of ['none', 'firsthand', 'secondhand', 'hypothetical']>\",\n  \"safety_interaction\": \"<one of ['none', 'positive', 'negative', 'betrayal']>\"\n}\n\nIf a field cannot be determined from the review, use the default:\n  incident_severity: \"none\"\n  account_type: \"none\"\n  safety_interaction: \"none\"",
  "array_assemblies": [
    {
      "array_name": "incident_severities",
      "source_field": "incident_severity",
      "filter_condition": "",
      "include_metadata": false
    },
    {
      "array_name": "account_types",
      "source_field": "account_type",
      "filter_condition": "",
      "include_metadata": false
    },
    {
      "array_name": "safety_interactions",
      "source_field": "safety_interaction",
      "filter_condition": "",
      "include_metadata": false
    },
    {
      "array_name": "review_stars",
      "source_field": "stars",
      "filter_condition": "",
      "include_metadata": false
    },
    {
      "array_name": "review_useful",
      "source_field": "useful",
      "filter_condition": "",
      "include_metadata": false
    },
    {
      "array_name": "review_years",
      "source_field": "year",
      "filter_condition": "",
      "include_metadata": false
    }
  ],
  "lookups": [
    {
      "name": "cuisine_modifier",
      "source_field": "categories",
      "mapping": {
        "Thai": 2.0,
        "Vietnamese": 1.8,
        "Chinese": 1.5,
        "Asian Fusion": 1.5,
        "Indian": 1.3,
        "Japanese": 1.2,
        "Korean": 1.2,
        "Mexican": 1.0,
        "Italian": 0.5,
        "American": 0.5,
        "Pizza": 0.5
      },
      "default": 1.0,
      "description": "Risk modifier based on cuisine type"
    }
  ],
  "computations": [
    {
      "name": "n_mild",
      "formula": "sum(1 for e in extractions if e[\"incident_severity\"] == \"mild\" and e[\"account_type\"] == \"firsthand\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Count of firsthand mild incidents",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_moderate",
      "formula": "sum(1 for e in extractions if e[\"incident_severity\"] == \"moderate\" and e[\"account_type\"] == \"firsthand\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Count of firsthand moderate incidents",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_severe",
      "formula": "sum(1 for e in extractions if e[\"incident_severity\"] == \"severe\" and e[\"account_type\"] == \"firsthand\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Count of firsthand severe incidents",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_total_incidents",
      "formula": "n_mild + n_moderate + n_severe",
      "depends_on": [
        "n_mild",
        "n_moderate",
        "n_severe"
      ],
      "description": "Total firsthand incidents",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_positive",
      "formula": "sum(1 for e in extractions if e[\"safety_interaction\"] == \"positive\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Count of positive safety interactions",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_negative",
      "formula": "sum(1 for e in extractions if e[\"safety_interaction\"] == \"negative\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Count of negative safety interactions",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_betrayal",
      "formula": "sum(1 for e in extractions if e[\"safety_interaction\"] == \"betrayal\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Count of betrayals (staff claimed safe but customer reacted)",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_allergy_reviews",
      "formula": "len(extractions)",
      "depends_on": [
        "extractions"
      ],
      "description": "Count of reviews mentioning allergy-related terms",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "trust_raw",
      "formula": "1.0 + (n_positive * 0.1) - (n_negative * 0.2) - (n_betrayal * 0.5)",
      "depends_on": [
        "n_positive",
        "n_negative",
        "n_betrayal"
      ],
      "description": "Raw trust baseline from interaction history",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "trust_score",
      "formula": "max(0.1, min(1.0, trust_raw))",
      "depends_on": [
        "trust_raw"
      ],
      "description": "Final trust score after bounds",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "mild_weight",
      "formula": "2 * (1.5 - trust_score)",
      "depends_on": [
        "trust_score"
      ],
      "description": "Weight for mild incidents based on trust",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "moderate_weight",
      "formula": "5 * (1.3 - 0.3 * trust_score)",
      "depends_on": [
        "trust_score"
      ],
      "description": "Weight for moderate incidents based on trust",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "adjusted_incident_score",
      "formula": "(n_mild * mild_weight) + (n_moderate * moderate_weight) + (n_severe * 15)",
      "depends_on": [
        "n_mild",
        "n_moderate",
        "n_severe",
        "mild_weight",
        "moderate_weight"
      ],
      "description": "Weighted sum of incidents",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "n_recent",
      "formula": "sum(1 for e in extractions if e[\"review_year\"] == \"{'operator': '>=', 'value': 2023}\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Incidents in 2023 or later",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_old",
      "formula": "sum(1 for e in extractions if e[\"review_year\"] == \"{'operator': '<', 'value': 2023}\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Incidents before 2023",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "recent_ratio",
      "formula": "n_recent / n_total_incidents if n_total_incidents > 0 else 0",
      "depends_on": [
        "n_recent",
        "n_total_incidents"
      ],
      "description": "Proportion of incidents that are recent",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "trajectory_multiplier",
      "formula": "1.3 if recent_ratio > 0.7 else (0.7 if (recent_ratio < 0.3 and n_total_incidents > 0) else 1.0)",
      "depends_on": [
        "recent_ratio",
        "n_total_incidents"
      ],
      "description": "Trajectory multiplier based on recency",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "most_recent_year",
      "formula": "2020 if n_total_incidents == 0 else max(r[\"review_year\"] for r in reviews if r[\"incident_severity\"] in (\"mild\",\"moderate\",\"severe\"))",
      "depends_on": [
        "reviews",
        "n_total_incidents"
      ],
      "description": "Most recent year among firsthand incidents",
      "is_aggregate": false,
      "is_output": false
    },
    {
      "name": "incident_age",
      "formula": "2025 - most_recent_year",
      "depends_on": [
        "most_recent_year"
      ],
      "description": "Age since most recent incident year",
      "is_aggregate": false,
      "is_output": false
    },
    {
      "name": "recency_decay",
      "formula": "max(0.3, 1.0 - (incident_age * 0.15))",
      "depends_on": [
        "incident_age"
      ],
      "description": "Decay factor based on recency",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "total_weight",
      "formula": "sum(((5 - r[\"stars\"]) + log(r[\"useful_votes\"] + 1)) for r in reviews if r[\"incident_severity\"] in (\"mild\",\"moderate\",\"severe\") and r[\"account_type\"] == \"firsthand\")",
      "depends_on": [
        "reviews"
      ],
      "description": "Total weight across detailed firsthand reviews",
      "is_aggregate": true,
      "is_output": false
    },
    {
      "name": "credibility_factor",
      "formula": "total_weight / n_total_incidents if n_total_incidents > 0 else 1.0",
      "depends_on": [
        "total_weight",
        "n_total_incidents"
      ],
      "description": "Average credibility per incident",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "incident_impact",
      "formula": "adjusted_incident_score * trajectory_multiplier * recency_decay * credibility_factor",
      "depends_on": [
        "adjusted_incident_score",
        "trajectory_multiplier",
        "recency_decay",
        "credibility_factor"
      ],
      "description": "Impact score from incidents considering trajectory, recency, and credibility",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "trust_impact",
      "formula": "(1.0 - trust_score) * 3.0",
      "depends_on": [
        "trust_score"
      ],
      "description": "Impact from remaining mistrust",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "positive_credit",
      "formula": "n_positive * trust_score * 0.5",
      "depends_on": [
        "n_positive",
        "trust_score"
      ],
      "description": "Credit for positive safety interactions weighted by trust",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "cuisine_mod_value",
      "formula": "cuisine_modifier",
      "depends_on": [
        "cuisine_modifier"
      ],
      "description": "Cuisine risk modifier from lookup",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "silence_penalty",
      "formula": "cuisine_mod_value * 0.5 if n_allergy_reviews == 0 else 0",
      "depends_on": [
        "n_allergy_reviews",
        "cuisine_mod_value"
      ],
      "description": "Penalty when no allergy discussion, scaled by cuisine",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "cuisine_impact",
      "formula": "(cuisine_mod_value * 0.5) + silence_penalty",
      "depends_on": [
        "cuisine_mod_value",
        "silence_penalty"
      ],
      "description": "Combined cuisine-related impact",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "raw_risk",
      "formula": "2.0 + incident_impact + trust_impact + cuisine_impact - positive_credit",
      "depends_on": [
        "incident_impact",
        "trust_impact",
        "cuisine_impact",
        "positive_credit"
      ],
      "description": "Raw risk before clamping",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "final_risk_score",
      "formula": "max(0.0, min(20.0, raw_risk))",
      "depends_on": [
        "raw_risk"
      ],
      "description": "Final risk score clamped to [0,20]",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "verdict",
      "formula": "\"Low Risk\" if final_risk_score < 4.0 else (\"High Risk\" if final_risk_score < 8.0 else \"Critical Risk\")",
      "depends_on": [
        "final_risk_score"
      ],
      "description": "Final verdict based on risk score",
      "is_aggregate": false,
      "is_output": true
    }
  ],
  "output_fields": [
    "n_mild",
    "n_moderate",
    "n_severe",
    "n_total_incidents",
    "n_positive",
    "n_negative",
    "n_betrayal",
    "n_allergy_reviews",
    "trust_score",
    "mild_weight",
    "moderate_weight",
    "adjusted_incident_score",
    "n_recent",
    "n_old",
    "recent_ratio",
    "trajectory_multiplier",
    "most_recent_year",
    "incident_age",
    "recency_decay",
    "total_weight",
    "credibility_factor",
    "incident_impact",
    "trust_impact",
    "positive_credit",
    "cuisine_modifier",
    "silence_penalty",
    "cuisine_impact",
    "raw_risk",
    "final_risk_score",
    "verdict"
  ],
  "name_map": {
    "incident_years": "review_years",
    "incident_stars": "review_stars",
    "incident_useful": "review_useful"
  }
}