{
  "task_name": "G1a-v2",
  "filter_keywords": [
    "peanut",
    "nut",
    "peanuts",
    "tree nut",
    "allergy",
    "allergies",
    "allergic",
    "anaphylaxis",
    "epiPen",
    "epinephrine",
    "allergic reaction"
  ],
  "extraction_fields": [
    {
      "name": "incident_severity",
      "field_type": "enum",
      "values": [
        "none",
        "mild",
        "moderate",
        "severe"
      ],
      "description": "Severity of allergic reaction",
      "extraction_hint": "none: No allergic reaction described; mild: Minor symptoms (stomach upset, mild discomfort); moderate: Visible symptoms (hives, swelling, needed medication); severe: Life-threatening (anaphylaxis, EpiPen, ER visit)"
    },
    {
      "name": "account_type",
      "field_type": "enum",
      "values": [
        "none",
        "firsthand",
        "secondhand",
        "hypothetical"
      ],
      "description": "Nature of the reported experience",
      "extraction_hint": "firsthand: Personal experience (e.g., 'I had', 'my child experienced'); secondhand: Reported by someone else (e.g., 'I heard', 'a friend told me'); hypothetical: Concern or scenario without an incident"
    },
    {
      "name": "safety_interaction",
      "field_type": "enum",
      "values": [
        "none",
        "positive",
        "negative",
        "betrayal"
      ],
      "description": "Staff interaction regarding allergy safety",
      "extraction_hint": "positive: Staff asked about allergies AND accommodated; negative: Staff dismissive or refused to accommodate; betrayal: Staff claimed safe BUT customer still had reaction; none: no interaction mentioned"
    }
  ],
  "extraction_prompt": "Analyze this restaurant review and extract the following signals.\n\nREVIEW:\n{review_text}\n\nREVIEW METADATA:\n- Date: {review_date}\n- Stars: {review_stars}\n- Useful votes: {review_useful}\n\nEXTRACT THESE FIELDS:\n\n**incident_severity**\n  Type: Choose ONE of ['none', 'mild', 'moderate', 'severe']\n  Description: Severity of allergic reaction\n  Hints: none: No allergic reaction described; mild: Minor symptoms (stomach upset, mild discomfort); moderate: Visible symptoms (hives, swelling, needed medication); severe: Life-threatening (anaphylaxis, EpiPen, ER visit)\n\n**account_type**\n  Type: Choose ONE of ['none', 'firsthand', 'secondhand', 'hypothetical']\n  Description: Nature of the reported experience\n  Hints: firsthand: Personal experience (e.g., 'I had', 'my child experienced'); secondhand: Reported by someone else (e.g., 'I heard', 'a friend told me'); hypothetical: Concern or scenario without an incident\n\n**safety_interaction**\n  Type: Choose ONE of ['none', 'positive', 'negative', 'betrayal']\n  Description: Staff interaction regarding allergy safety\n  Hints: positive: Staff asked about allergies AND accommodated; negative: Staff dismissive or refused to accommodate; betrayal: Staff claimed safe BUT customer still had reaction; none: no interaction mentioned\n\nOUTPUT FORMAT:\nReturn a JSON object with these exact keys:\n{\n  \"incident_severity\": \"<one of ['none', 'mild', 'moderate', 'severe']>\",\n  \"account_type\": \"<one of ['none', 'firsthand', 'secondhand', 'hypothetical']>\",\n  \"safety_interaction\": \"<one of ['none', 'positive', 'negative', 'betrayal']>\"\n}\n\nIf a field cannot be determined from the review, use the default:\n  incident_severity: \"none\"\n  account_type: \"none\"\n  safety_interaction: \"none\"",
  "array_assemblies": [
    {
      "array_name": "incident_severities",
      "source_field": "incident_severity",
      "filter_condition": "",
      "include_metadata": false
    },
    {
      "array_name": "account_types",
      "source_field": "account_type",
      "filter_condition": "",
      "include_metadata": false
    },
    {
      "array_name": "safety_interactions",
      "source_field": "safety_interaction",
      "filter_condition": "",
      "include_metadata": false
    },
    {
      "array_name": "review_stars",
      "source_field": "stars",
      "filter_condition": "",
      "include_metadata": false
    },
    {
      "array_name": "review_useful",
      "source_field": "useful",
      "filter_condition": "",
      "include_metadata": false
    },
    {
      "array_name": "review_years",
      "source_field": "year",
      "filter_condition": "",
      "include_metadata": false
    }
  ],
  "lookups": [
    {
      "name": "cuisine_modifier",
      "source_field": "categories",
      "mapping": {
        "Thai": 2.0,
        "Vietnamese": 1.8,
        "Chinese": 1.5,
        "Asian Fusion": 1.5,
        "Indian": 1.3,
        "Japanese": 1.2,
        "Korean": 1.2,
        "Mexican": 1.0,
        "Italian": 0.5,
        "American": 0.5,
        "Pizza": 0.5
      },
      "default": 1.0,
      "description": "Risk modifier based on cuisine type"
    }
  ],
  "computations": [
    {
      "name": "n_mild",
      "formula": "sum(1 for e in extractions if e[\"incident_severity\"] == \"mild\" and e[\"account_type\"] == \"firsthand\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Count of firsthand mild incidents",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_moderate",
      "formula": "sum(1 for e in extractions if e[\"incident_severity\"] == \"moderate\" and e[\"account_type\"] == \"firsthand\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Count of firsthand moderate incidents",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_severe",
      "formula": "sum(1 for e in extractions if e[\"incident_severity\"] == \"severe\" and e[\"account_type\"] == \"firsthand\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Count of firsthand severe incidents",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_total_incidents",
      "formula": "n_mild + n_moderate + n_severe",
      "depends_on": [
        "n_mild",
        "n_moderate",
        "n_severe"
      ],
      "description": "Total firsthand incidents",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_positive",
      "formula": "sum(1 for e in extractions if e[\"safety_interaction\"] == \"positive\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Total positive safety interactions",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_negative",
      "formula": "sum(1 for e in extractions if e[\"safety_interaction\"] == \"negative\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Total negative safety interactions",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_betrayal",
      "formula": "sum(1 for e in extractions if e[\"safety_interaction\"] == \"betrayal\")",
      "depends_on": [
        "extractions"
      ],
      "description": "Total betrayal safety interactions",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_allergy_reviews",
      "formula": "len(extractions)",
      "depends_on": [
        "extractions"
      ],
      "description": "Total allergy-relevant reviews",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "trust_raw",
      "formula": "1.0 + (n_positive * 0.1) - (n_negative * 0.2) - (n_betrayal * 0.5)",
      "depends_on": [
        "n_positive",
        "n_negative",
        "n_betrayal"
      ],
      "description": "Raw staff trust score before clamping",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "trust_score",
      "formula": "max(0.1, min(1.0, trust_raw))",
      "depends_on": [
        "trust_raw"
      ],
      "description": "Clamped trust score between 0.1 and 1.0",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "mild_weight",
      "formula": "2 * (1.5 - trust_score)",
      "depends_on": [
        "trust_score"
      ],
      "description": "Weight for mild incidents depending on trust",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "moderate_weight",
      "formula": "5 * (1.3 - 0.3 * trust_score)",
      "depends_on": [
        "trust_score"
      ],
      "description": "Weight for moderate incidents depending on trust",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "adjusted_incident_score",
      "formula": "n_mild * mild_weight + n_moderate * moderate_weight + n_severe * 15",
      "depends_on": [
        "n_mild",
        "n_moderate",
        "n_severe",
        "mild_weight",
        "moderate_weight"
      ],
      "description": "Trust-adjusted weighted incident score",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "n_recent",
      "formula": "sum(1 for r in incident_reviews if r['review_year'] >= 2023 and r['incident_severity'] in ['mild','moderate','severe'])",
      "depends_on": [
        "incident_reviews"
      ],
      "description": "Incidents in 2023 or later",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "n_old",
      "formula": "sum(1 for r in incident_reviews if r['review_year'] < 2023 and r['incident_severity'] in ['mild','moderate','severe'])",
      "depends_on": [
        "incident_reviews"
      ],
      "description": "Incidents before 2023",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "recent_ratio",
      "formula": "n_recent / n_total_incidents if n_total_incidents > 0 else 0",
      "depends_on": [
        "n_recent",
        "n_total_incidents"
      ],
      "description": "Proportion of recent incidents",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "trajectory_multiplier",
      "formula": "1.3 if recent_ratio > 0.7 else (0.7 if (recent_ratio < 0.3 and n_total_incidents > 0) else 1.0)",
      "depends_on": [
        "recent_ratio",
        "n_total_incidents"
      ],
      "description": "Trajectory multiplier based on recent trend",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "cuisine_modifier",
      "formula": "max([2.0 if 'Thai' in categories else 0, 1.8 if 'Vietnamese' in categories else 0, 1.5 if 'Chinese' in categories else 0, 1.5 if 'Asian Fusion' in categories else 0, 1.3 if 'Indian' in categories else 0, 1.2 if 'Japanese' in categories else 0, 1.2 if 'Korean' in categories else 0, 1.0 if 'Mexican' in categories else 0, 0.5 if 'Italian' in categories else 0, 0.5 if 'American' in categories else 0, 0.5 if 'Pizza' in categories else 0, 0.0]) if isinstance(categories, (list, tuple)) else 1.0",
      "depends_on": [
        "categories"
      ],
      "description": "Cuisine risk modifier derived from restaurant category/categories",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "silence_penalty",
      "formula": "cuisine_modifier * 0.5 if n_allergy_reviews == 0 else 0",
      "depends_on": [
        "cuisine_modifier",
        "n_allergy_reviews"
      ],
      "description": "Silence penalty when no allergy-relevant reviews",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "cuisine_impact",
      "formula": "(cuisine_modifier * 0.5) + silence_penalty",
      "depends_on": [
        "cuisine_modifier",
        "silence_penalty"
      ],
      "description": "Combined cuisine-related impact",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "most_recent_year",
      "formula": "max(r['review_year'] for r in incident_reviews) if n_total_incidents > 0 else 2020",
      "depends_on": [
        "incident_reviews",
        "n_total_incidents"
      ],
      "description": "Most recent incident year",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "incident_age",
      "formula": "2025 - most_recent_year",
      "depends_on": [
        "most_recent_year"
      ],
      "description": "Years since most recent incident (as of 2025)",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "recency_decay",
      "formula": "max(0.3, 1.0 - (incident_age * 0.15))",
      "depends_on": [
        "incident_age"
      ],
      "description": "Decay factor based on how old the most recent incident is",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "total_weight",
      "formula": "sum(((5 - r['stars']) + log(r['useful_votes'] + 1)) for r in incident_reviews if 'stars' in r and 'useful_votes' in r)",
      "depends_on": [
        "incident_reviews"
      ],
      "description": "Total weight across all incident reviews for credibility",
      "is_aggregate": true,
      "is_output": true
    },
    {
      "name": "credibility_factor",
      "formula": "total_weight / n_total_incidents if n_total_incidents > 0 else 1.0",
      "depends_on": [
        "total_weight",
        "n_total_incidents"
      ],
      "description": "Average credibility per incident",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "incident_impact",
      "formula": "adjusted_incident_score * trajectory_multiplier * recency_decay * credibility_factor",
      "depends_on": [
        "adjusted_incident_score",
        "trajectory_multiplier",
        "recency_decay",
        "credibility_factor"
      ],
      "description": "Impact of incidents considering trajectory, recency, and credibility",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "trust_impact",
      "formula": "(1.0 - trust_score) * 3.0",
      "depends_on": [
        "trust_score"
      ],
      "description": "Impact of trust deficit on risk",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "positive_credit",
      "formula": "n_positive * trust_score * 0.5",
      "depends_on": [
        "n_positive",
        "trust_score"
      ],
      "description": "Credit from positive interactions weighted by trust",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "raw_risk",
      "formula": "2.0 + incident_impact + trust_impact + cuisine_impact - positive_credit",
      "depends_on": [
        "incident_impact",
        "trust_impact",
        "cuisine_impact",
        "positive_credit"
      ],
      "description": "Unclamped final risk score before bounds",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "final_risk_score",
      "formula": "max(0.0, min(20.0, raw_risk))",
      "depends_on": [
        "raw_risk"
      ],
      "description": "Final risk score clamped to [0, 20]",
      "is_aggregate": false,
      "is_output": true
    },
    {
      "name": "verdict",
      "formula": "\"Low Risk\" if final_risk_score < 4.0 else (\"High Risk\" if final_risk_score < 8.0 else \"Critical Risk\")",
      "depends_on": [
        "final_risk_score"
      ],
      "description": "Final verdict based on risk score",
      "is_aggregate": false,
      "is_output": true
    }
  ],
  "output_fields": [
    "n_mild",
    "n_moderate",
    "n_severe",
    "n_total_incidents",
    "n_positive",
    "n_negative",
    "n_betrayal",
    "n_allergy_reviews",
    "trust_score",
    "mild_weight",
    "moderate_weight",
    "adjusted_incident_score",
    "n_recent",
    "n_old",
    "recent_ratio",
    "trajectory_multiplier",
    "cuisine_modifier",
    "silence_penalty",
    "cuisine_impact",
    "most_recent_year",
    "incident_age",
    "recency_decay",
    "total_weight",
    "credibility_factor",
    "incident_impact",
    "trust_impact",
    "positive_credit",
    "raw_risk",
    "final_risk_score",
    "verdict"
  ],
  "name_map": {
    "incident_years": "review_years",
    "incident_stars": "review_stars",
    "incident_useful": "review_useful"
  }
}