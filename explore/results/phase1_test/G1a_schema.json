{
  "task_name": "G1a",
  "extraction_fields": [
    {
      "name": "incident_severity",
      "field_type": "enum",
      "values": [
        "none",
        "mild",
        "moderate",
        "severe"
      ],
      "description": "Severity of any allergic incident described in the review"
    },
    {
      "name": "account_type",
      "field_type": "enum",
      "values": [
        "none",
        "firsthand",
        "secondhand",
        "hypothetical"
      ],
      "description": "Origin of the allergy incident in the account"
    },
    {
      "name": "safety_interaction",
      "field_type": "enum",
      "values": [
        "none",
        "positive",
        "negative",
        "betrayal"
      ],
      "description": "Staff interaction about allergies and accommodation"
    }
  ],
  "review_metadata": [
    "stars",
    "date",
    "useful"
  ],
  "filter_keywords": [
    "allergy",
    "allergic",
    "peanut",
    "peanuts",
    "nut",
    "nuts",
    "tree nut",
    "tree nuts",
    "anaphylaxis",
    "epipen",
    "epinephrine",
    "allergen",
    "allergen(s)",
    "allergy-safe",
    "allergen-safe",
    "safety"
  ],
  "aggregations": [
    {
      "name": "N_MILD",
      "formula": "COUNT(incident_severity='mild' AND account_type='firsthand')",
      "description": "Firsthand reviews with mild incidents"
    },
    {
      "name": "N_MODERATE",
      "formula": "COUNT(incident_severity='moderate' AND account_type='firsthand')",
      "description": "Firsthand reviews with moderate incidents"
    },
    {
      "name": "N_SEVERE",
      "formula": "COUNT(incident_severity='severe' AND account_type='firsthand')",
      "description": "Firsthand reviews with severe incidents"
    },
    {
      "name": "N_TOTAL_INCIDENTS",
      "formula": "N_MILD + N_MODERATE + N_SEVERE",
      "description": "Total first-hand incident reviews"
    },
    {
      "name": "N_POSITIVE",
      "formula": "COUNT(safety_interaction='positive')",
      "description": "Total positive safety interactions"
    },
    {
      "name": "N_NEGATIVE",
      "formula": "COUNT(safety_interaction='negative')",
      "description": "Total negative safety interactions"
    },
    {
      "name": "N_BETRAYAL",
      "formula": "COUNT(safety_interaction='betrayal')",
      "description": "Total betrayal safety interactions"
    },
    {
      "name": "N_ALLERGY_REVIEWS",
      "formula": "COUNT(allergy_mentions=true)",
      "description": "Reviews mentioning allergy-related terms"
    }
  ],
  "computations": [
    {
      "name": "INCIDENT_SCORE",
      "formula": "(N_MILD * 2) + (N_MODERATE * 5) + (N_SEVERE * 15)",
      "depends_on": [
        "N_MILD",
        "N_MODERATE",
        "N_SEVERE"
      ],
      "description": "Weighted incident score by severity"
    },
    {
      "name": "SAFETY_CREDIT",
      "formula": "(N_POSITIVE * 1.0) - (N_NEGATIVE * 0.5) - (N_BETRAYAL * 5.0)",
      "depends_on": [
        "N_POSITIVE",
        "N_NEGATIVE",
        "N_BETRAYAL"
      ],
      "description": "Net credit from safety interactions"
    },
    {
      "name": "CUISINE_MODIFIER",
      "formula": "CUISINE_MODIFIER_LOOKUP.get(restaurant_category, 1.0)",
      "depends_on": [
        "restaurant_category",
        "CUISINE_MODIFIER_LOOKUP"
      ],
      "description": "Restaurant cuisine safety modifier based on category"
    },
    {
      "name": "REVIEW_DENSITY",
      "formula": "min(1.0, N_ALLERGY_REVIEWS / 10.0)",
      "depends_on": [
        "N_ALLERGY_REVIEWS"
      ],
      "description": "Density of allergy-related reviews"
    },
    {
      "name": "CONFIDENCE_PENALTY",
      "formula": "1.0 - (0.3 * (1 - REVIEW_DENSITY))",
      "depends_on": [
        "REVIEW_DENSITY"
      ],
      "description": "Confidence penalty based on review density"
    },
    {
      "name": "MOST_RECENT_INCIDENT_YEAR",
      "formula": "max(years_of_incident_reviews, default=2020)",
      "depends_on": [
        "years_of_incident_reviews"
      ],
      "description": "Most recent incident year with default 2020"
    },
    {
      "name": "INCIDENT_AGE",
      "formula": "2025 - MOST_RECENT_INCIDENT_YEAR",
      "depends_on": [
        "MOST_RECENT_INCIDENT_YEAR"
      ],
      "description": "Age since the most recent incident year (relative to 2025)"
    },
    {
      "name": "RECENCY_DECAY",
      "formula": "max(0.3, 1.0 - (INCIDENT_AGE * 0.15))",
      "depends_on": [
        "INCIDENT_AGE"
      ],
      "description": "Recency decay factor"
    },
    {
      "name": "WEIGHT_PER_INCIDENT",
      "formula": "(5 - stars) + log(useful + 1)",
      "depends_on": [
        "stars",
        "useful"
      ],
      "description": "Per-incident weight for credibility"
    },
    {
      "name": "TOTAL_INCIDENT_WEIGHT",
      "formula": "SUM(WEIGHT_PER_INCIDENT) over incident_reviews",
      "depends_on": [
        "WEIGHT_PER_INCIDENT",
        "incident_reviews"
      ],
      "description": "Total weight across incident reviews"
    },
    {
      "name": "CREDIBILITY_FACTOR",
      "formula": "TOTAL_INCIDENT_WEIGHT / max(N_TOTAL_INCIDENTS, 1)",
      "depends_on": [
        "TOTAL_INCIDENT_WEIGHT",
        "N_TOTAL_INCIDENTS"
      ],
      "description": "Overall credibility factor"
    },
    {
      "name": "INCIDENT_IMPACT",
      "formula": "INCIDENT_SCORE * RECENCY_DECAY * CREDIBILITY_FACTOR",
      "depends_on": [
        "INCIDENT_SCORE",
        "RECENCY_DECAY",
        "CREDIBILITY_FACTOR"
      ],
      "description": "Impact of incidents on risk"
    },
    {
      "name": "SAFETY_IMPACT",
      "formula": "SAFETY_CREDIT * CONFIDENCE_PENALTY",
      "depends_on": [
        "SAFETY_CREDIT",
        "CONFIDENCE_PENALTY"
      ],
      "description": "Impact of safety interactions on risk"
    },
    {
      "name": "CUISINE_IMPACT",
      "formula": "CUISINE_MODIFIER * 0.5",
      "depends_on": [
        "CUISINE_MODIFIER"
      ],
      "description": "Impact of cuisine category"
    },
    {
      "name": "RAW_RISK",
      "formula": "BASE_RISK + INCIDENT_IMPACT - SAFETY_IMPACT + CUISINE_IMPACT - (N_BETRAYAL * 3.0)",
      "depends_on": [
        "BASE_RISK",
        "INCIDENT_IMPACT",
        "SAFETY_IMPACT",
        "CUISINE_IMPACT",
        "N_BETRAYAL"
      ],
      "description": "Unclamped risk before final enforcement"
    },
    {
      "name": "FINAL_RISK_SCORE",
      "formula": "max(0.0, min(20.0, RAW_RISK))",
      "depends_on": [
        "RAW_RISK"
      ],
      "description": "Final risk score bounded between 0 and 20"
    }
  ],
  "lookups": [
    {
      "name": "CUISINE_MODIFIER_LOOKUP",
      "mapping": {
        "Thai": 2.0,
        "Vietnamese": 1.8,
        "Chinese": 1.5,
        "Asian": 1.5,
        "Indian": 1.3,
        "Japanese": 1.2,
        "Korean": 1.2,
        "Mexican": 1.0,
        "Italian": 0.5,
        "American": 0.5,
        "Pizza": 0.5
      },
      "default": 1.0,
      "source_field": "restaurant_category"
    }
  ],
  "output_fields": [
    "N_MILD",
    "N_MODERATE",
    "N_SEVERE",
    "N_TOTAL_INCIDENTS",
    "N_POSITIVE",
    "N_NEGATIVE",
    "N_BETRAYAL",
    "N_ALLERGY_REVIEWS",
    "REVIEW_DENSITY",
    "CONFIDENCE_PENALTY",
    "MOST_RECENT_INCIDENT_YEAR",
    "INCIDENT_AGE",
    "RECENCY_DECAY",
    "WEIGHT_PER_INCIDENT",
    "TOTAL_INCIDENT_WEIGHT",
    "CREDIBILITY_FACTOR",
    "INCIDENT_IMPACT",
    "SAFETY_IMPACT",
    "CUISINE_IMPACT",
    "RAW_RISK",
    "FINAL_RISK_SCORE",
    "VERDICT"
  ],
  "verdict_rule": {
    "source_field": "FINAL_RISK_SCORE",
    "thresholds": [
      {
        "max": 3.9999,
        "verdict": "Low Risk"
      },
      {
        "min": 4.0,
        "max": 7.9999,
        "verdict": "High Risk"
      },
      {
        "min": 8.0,
        "verdict": "Critical Risk"
      }
    ]
  },
  "extraction_prompt_template": "You are an AI assistant that extracts allergy-safety signals from a single review.\n\nPlaceholders to use: REVIEW_TEXT, REVIEW_STARS, REVIEW_DATE.\n\nFrom REVIEW_TEXT, determine and return a JSON object with the following fields:\n- incident_severity: one of 'none','mild','moderate','severe'. Describe any allergic incident severity described in the review.\n- account_type: one of 'none','firsthand','secondhand','hypothetical'. Indicate the origin of the allergy incident in the account.\n- safety_interaction: one of 'none','positive','negative','betrayal'. Indicate staff interaction about allergies and accommodations.\n\nReturn a JSON object with exactly these keys and values taken from the allowed enumerations. Do not include any additional fields."
}